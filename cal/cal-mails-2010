
Cal Heldenbrand <cal@fbsdata.com> said:
> >
> > 21600 seems very obvious timezone issue.
> >
> > On Unix the timezone behaviour of a process is determined by setting
> > of TZ environment variable. To my best knowledge I always use gmtime(3)
> > which to my best understanding ignores the TZ environment variable.
> > However, it is possible that I errornously or the Shib IdP use
> > localtime(3), which will take TZ in account. Therefore I recommend
> > launching all processes with environment TZ=GMT (see the date
> > example above).
> >
> >
> In apache, I added a SetEnv TZ "GMT"  and also in tomcat I exported the TZ
> variable in catalina.sh.  Just to make sure it made it in tomcat, I checked
> /proc/pid/environ for the variable, and it was set.
> 
> I tried the login again, and I still get:
> 
> t  zxidsso.c:466 zxid_validate_cond     zx d ssof: NotOnOrAfter ok. Time to
> expiry 21900 secs
> t  zxidsso.c:476 zxid_validate_cond     zx E ssof: NotBefore rejected with
> slop of 7300. Time to validity 21600 secs
> 
> And what doesn't make sense to me, is that the assertions and responses all
> use GMT as the timestamp format.  The only conclusion that I can come to, is
> zxid is receiving the time in GMT from the IdP, but when it compares that
> time to the local time on the SP, it is receiving CDT.  Or possibly CST.
> Right now we're 5 hours behind GMT, so 21600 (6 hours) doesn't make any
> sense.  Also, I'm not sure why NotOnOrAfter passed the check, but that's
> exactly 6 hours and 5 minutes.  (300 seconds seems like it should be the
> sane value there)
> 
> Could you satisfy my curiosity and add a quick debug print to show both
> times on those checks?  I'd like to determine if it's the SP or IdP that is
> processing the time wrong.

I have added the checks. git pull.

> With the simple API, I might mess around with switching to it.  I just have
> to pick through the states and massage it into something that works with
> mod_perl.  So far, my usage of the low level API seems to mirror what the
> simple API is doing anyway.  Do you foresee any problems with what I'm
> doing, or do you think it's more error prone than the simple API?

I do not see any immediate problem with the "raw" api (as exemplified by
zxid.pl), but on long term there are supportability issues. I have made
an explicity commitment to stabilize the zxid_simple() API, while I have
not made similar commitment WRT the raw API. You should also see that
the zxid_simple() is much better documented.

I notice one of your deciding factors was apparently uncontrolled
behaviour where zxid_simple() seemed to do too much for your taste.
This is mainly dues to the auto_flags, which is the last argument
to zxid_simple(). The flags are discussed in depth in zxid-simp.pd,
but I can see why they might be easy to miss. Perhpas having auto_flags
in parallel to the configuration mechanism was a design error on
my part. Of course autodetecting everything would be best, but
if I can't autodetect, I need the hints that auto_flags provides.
I could make them config options, but then they would affect code
that shares /var/zxid/zxid.conf: for example if one part of your SP
is done with mod_auth_saml and another was provided using Net::SAML.
They should be able to share most of the configuration and somehow
indicate at implementatin level that they are different animals.
Perhaps I will add more simplified zxid_simple() family functions
that do not take the cumbersome auto_flags argument, but instead
hardwire it for a specific purpose. Then you would choose the best
API function to use from a catalog of perhaps 10 rather than
trying to compute the auto_flags bits that are most optimal
for your situation.

Thanks for listening to this monolog. Having feedback has been
most helpful.

Here's the new perl documentation (from .pod, also reproduced in
zxid-perl.pd and zxid-simp.pd):

=head1 EXAMPLE

You should see zxid-perl.pd, zxid-simp.pd, and zxid-conf.pd for more complete
documentation. Here is a quick walk through of a typical SP usage:

  01 use Net::SAML;
  02 $| = 1; undef $/;  # Flush pipes, read all in at once
  03 $url = "http://sp.tas3.pt:8082/zxidhlo.pl";  # Edit to match your situation
  04 $conf = "PATH=/var/zxid/&URL=$url";
  05 $cf = Net::SAML::new_conf_to_cf($conf);
  06 $qs = $ENV{'QUERY_STRING'};
  07 $qs = <STDIN> if $qs =~ /o=P/;
  08 $res = Net::SAML::simple_cf($cf, -1, $qs, undef, 0x1828);
  09 $op = substr($res, 0, 1);
  10 if ($op eq 'L' || $op eq 'C') { print $res; exit; } # LOCATION (Redir) or CONTENT
  11 if ($op eq 'n') { exit; } # already handled
  12 if ($op eq 'e') { my_render_idpsel_screen(); exit; }
  13 if ($op ne 'd') { die "Unknown Net::SAML::simple() res($res)"; }
  14
  15 ($sid) = $res =~ /^sesid: (.*)$/m;  # Extract a useful attribute from SSO output
  16
  17 print <<HTML
  18 CONTENT-TYPE: text/html
  19
  20 <title>ZXID perl HLO SP Mgmt & Protected Content</title>
  21 <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  22 <link type="text/css" rel=stylesheet href="idpsel.css">
  23 <body bgcolor=white><font face=sans>
  24 
  25 <h1>ZXID SP Perl HLO Management & Protected Content (user logged in, session active)</h1>
  26 sesid: $sid
  27 HTML
  28     ;
  29 print Net::SAML::fed_mgmt_cf($cf, undef, -1, $sid, 0x1900);
  30 exit;
  31
  32 sub my_render_idpsel_screen {  # Replaces traditional login screen
  33     print <<HTML;
  34 CONTENT-TYPE: text/html
  35
  36 <title>ZXID SP PERL HLO SSO IdP Selection</title>
  37 <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  38 <link type="text/css" rel=stylesheet href="idpsel.css">
  39 <body bgcolor=white><font face=sans>
  40 <h1>ZXID SP Perl HLO Federated SSO IdP Selection (user NOT logged in, no session.)</h1>
  41 <form method=get action="zxidhlo.pl">
  42
  43 <h3>Login Using New IdP</h3>
  44
  45 <i>A new IdP is one whose metadata we do not have yet. We need to know
  46 the Entity ID in order to fetch the metadata using the well known
  47 location method. You will need to ask the adminstrator of the IdP to
  48 tell you what the EntityID is.</i>
  49
  50 <p>IdP URL <input name=e size=60><input type=submit name=l2 value=" Login ">
  51 HTML
  52 ;
  53     print Net::SAML::idp_list_cf($cf, undef, 0x1c00);   # Get the IdP selection form
  54     print <<HTML;
  55 <h3>CoT configuration parameters your IdP may need to know</h3>
  56
  57 Entity ID of this SP: <a href="$url?o=B">$url?o=B</a> (Click on the link to fetch SP metadata.)
  58
  59 <input type=hidden name=fc value=1><input type=hidden name=fn value=prstnt>
  60 <input type=hidden name=fq value=""><input type=hidden name=fy value="">
  61 <input type=hidden name=fa value=""><input type=hidden name=fm value="">
  62 <input type=hidden name=fp value=0><input type=hidden name=ff value=0>
  63
  64 </form><hr><a href="http://zxid.org/">zxid.org</a>
  65 HTML
  66     ;
  67 }

This example only demosntrates SSO.

Lines 1-5 set up the configuration. See zxid-conf.pd for guidance.

ll.6-7 reads in the CGI input the perl way.

l.8 runs the SAML engine of ZXID. The engine will return result that
is processed below. The magic constant 0x1828 sets some flags, see
zxid-simp.pd for explanation. This explanation may be especially relevant
if you plan to run as mod_perl process rather than as a CGI. With
these flags you could eliminate the need to render the IdP selection
screen.

ll.9-13: interpret the return value. l.10 deals with parts of SAML
protocol that need redirect or content. l.12 deals with rendering the
IdP selection screen. This screen replaces the traditional login
screen in most applications.

l.15 demonstrates how to extract attributes from the return value. The ret
is formatted as LDIF so it is very easy to parse with perl.

ll.17-30 render the "protected content". Most protected content should
contain also Single Logout button. This is accomplished on l.29.
Protected content is where your normal application after SSO lives.
You can rely in ZXID session mechanism and just show the content,
or you could bootstrap your application's session mechanism here.

ll.32-67 render the "idp selection" screen. This could have been
automatically generated has the flags to Net::SAML::simple_cf()
been different (see zxid-simp.pd for explanation).

As can be seen, the most central logic for SSO is only about 10 lines. The
rest is user interface.

> Again, thanks for all of the help!  I think I'm heading out for the day, so
> go ahead and get outside for a beer on me.  ;-)

Cheers, I will.
--Sampo

> --Cal


From	"Scott Cantor" <cantor.2@osu.edu>
To	<sampo@zxidp.org>
Cc	<cal@fbsdata.com>
Date	Tue, 5 Oct 2010 10:30:53 -0400 -- arrived: Ti 5.10. 14h23 -- 3.56K
Subject	RE: Shib IdP 2.1.5 exc-xml-c14n bug on InclusiveNamespace
> Question: How can my user obtain the canonicalized form in the IdP end?
> What debugging flags and logs he needs to turn on to see the input
> to your SHA1 computation?

https://spaces.internet2.edu/display/OpenSAML/OSTwoUserManSigErrors

org.apache.xml.security.utils.DigesterOutputStream is the logging category.

> But this canonicalization is wrong because it ignores
> InclusiveNamespaces/@PrefixList, thus violating section 3, bullet 2,
> of [XML-EXC-C14N]. This part of the spec is very bad and difficult to
> understand, merely stating "All namespace nodes appearing on this list
> are handled as provided in Canonical XML [XML-C14N]." for whatever
> that might mean. However studying non-normative section 3.1 bullet 3.2.1
> of [XML-EXC-C14N] makes it clear that the xmlns:ds needs to be rendered.

No, it doesn't. Unless there's a surrounding use of ds in the parent nodes
of the assertion (if any), then when you canonicalize the assertion the
first node on which the ds prefix would be rendered is the node where it
appears, not the root of the node set. Treating it inclusively doesn't
promote it to the root unless it's declared there or above, it simply means
that it's rendered the first time it's encountered regardless of whether
it's visibly used.

> 2. Fix your XML canonicalizator to deal correctly with
InclusiveNamespaces.
> Problem with this fix, if not combined with (1) is that it may
> break your installed base.

I think the bug may be yours (per the above confusion), but I'm also not the
Java developer and there may be more going on here than I'm aware of. There
are some hints in the page above regarding testing things, such as trying
Oxygen or similar tools. I think I can safely prove that what the IdP is
generating will verify. If not, feel free to file a bug and attach the XML
unmodified.

One reason I'm fairly confident about the signing is that my
implementation's signing library is completely distinct from the IdP's, so
when there are issues, they show up in one or the other already.

-- Scott

From: sampo@zxidp.org
To: cantor.2@osu.edu
Cc: cal@fbsdata.com, sampo@zxidp.org
Subject: Shib IdP 2.1.5 exc-xml-c14n bug on InclusiveNamespace

A user of mine has signature interoperation problem between
Shibboleth IdP 2.1.5 and zxid SP 0.64 on POST SSO.

It boils down to Shib ignoring InclusiveNamespaces PrefixList
when canonicalizing, yet passing it as part of the signature.

Shib IdP gives following assertion (all line end whitespace in the original
is inside <Signature> element so whether email mangles that should not
matter - if there are any line ends in the assertion itself, those would
have to be removed before computing SHA1):

<saml2:Assertion xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" ID="_fbb64868745bf00d0967899f87b2ab55" IssueInstant="2010-10-01T20:13:51.703Z" Version="2.0"><saml2:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity">http://saml.flexmls.com/idp/shibboleth</saml2:Issuer><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
<ds:SignedInfo>
<ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
<ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
<ds:Reference URI="#_fbb64868745bf00d0967899f87b2ab55">
<ds:Transforms>
<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
<ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"><ec:InclusiveNamespaces xmlns:ec="http://www.w3.org/2001/10/xml-exc-c14n#" PrefixList="ds saml2"/></ds:Transform>
</ds:Transforms>
<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
<ds:DigestValue>tJQBOaU5JDRdtFgTRMrUe3K7Sqk=</ds:DigestValue>
</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>
SghbDRHkt3DjgZHCui8bCetdkeSuVwIv8wNmOipC+4ZcUHV6e8ldnCl891SxJJPyKk4PlpOg/eY6
+XdQuvsmtoXz9yiaQiU7vd8WYcu07fjvEgjDtWQGovzlxefQL4anKPC3Nn1eV/Buwk1/ngAf0Wee
KvlS4KMKy1Oz4gEGtTEIe4mgEeP4PoZdjt+BhURCovE8rJmIMalbGQSGt3oSbY0/hzMw4XZBEnUD
vffV3Rs+knQpuzGR57Ke9XxCPjeMPfu5BMjaECmT0T2HTB9UcEkcMLwioEgKlkkGdximkEsY4957
LNmJQ2q1i97xh1eJWbOpQpg+EXuPkM2OiSLOWA==
</ds:SignatureValue>
<ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIDLDCCAhSgAwIBAgIVALXdK32E0QYMthR36rFgaVqN/fqyMA0GCSqGSIb3DQEBBQUAMBsxGTAX
BgNVBAMTEHNhbWwuZmxleG1scy5jb20wHhcNMTAwOTI0MTYwMzM2WhcNMzAwOTI0MTYwMzM2WjAb
MRkwFwYDVQQDExBzYW1sLmZsZXhtbHMuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEArs3NVzXAsTHF50qXo73+i/3Am1QYo0psCSqhfe0EFxHN3tcoW0VY4Ti+AMp/lSJMwSTCkMAx
/M+pzmyA3BpEWb4SMxDDVKb9xjSGzItWWWO0W6LBNheLZfjnyMKyl1yYxl846hsUhEogTWuAMA95
R6yIeZ0DdfKNh1MYI7brfW7x3x17SvCodovnWo/Ml9p/qysopHU0e8TS+jDKDTjw0f+SWBYSXpg+
2IuHzZU7wbM8AwivBlEYpefFxR5FWfdwqVpTj8sG7ka/UfotrorjoOVP2alLy4TXHUYFJUnx75HP
Q/clgGG6OhPRVRNQ8jOxJ2uveVUe+LVPBFbHUmH/FwIDAQABo2cwZTBEBgNVHREEPTA7ghBzYW1s
LmZsZXhtbHMuY29thidodHRwczovL3NhbWwuZmxleG1scy5jb20vaWRwL3NoaWJib2xldGgwHQYD
VR0OBBYEFJ4/u83XOq77eULMck7cqo2JJ7MbMA0GCSqGSIb3DQEBBQUAA4IBAQCbD1+aFWlKz7pd
/dK0SZbIpYaSMvWfuuc9O4r7HuiTguGpYgLjYWlG0j8Pe5r0iz1jHKuE51wh0SIC4Mg/zMWKV+H5
nrzSfvPr0lUU4NChD4+kn/gjcAb4D0Dq9XesVMQhptpqiIx3TC0QP9pA99ndU0E3S/lnoPUTBwk4
GaxxwEVTTFOuVvjsavMIcl4o/me66mAewouoGxRwT2OHEolBdq8sdCFEvumzII6xxnbNlootd/N7
DdSGPK3VVavhBDYXYzAAlxacmriODS34KpZfWxzXM7WUV2OuL8krLsE3cxwhuIS7Mcm4JchTgeee
rpMxWD2PsuuWxTuDOiQbd8mH</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">cal</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData Address="216.147.179.14" InResponseTo="Nh4C91R3rLrc1c7pQWP9Q0r61" NotOnOrAfter="2010-10-01T20:18:51.703Z" Recipient="http://samltest-zxid.flexmls.com/ticketLogin?o=P"/></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2010-10-01T20:13:51.703Z" NotOnOrAfter="2010-10-01T20:18:51.703Z"><saml2:AudienceRestriction><saml2:Audience>http://samltest-zxid.flexmls.com/ticketLogin?o=B</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2010-10-01T20:13:51.683Z" SessionIndex="0f66886ce6d0ee7f605e76887a0f027dd1e38584e549818687ed5b8352af1dc4"><saml2:SubjectLocality Address="216.147.179.14"/><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion>

As you can see, the InclusiveNamespaces/@PrefixList contains "ds saml2".

I canonicalize this as

<saml2:Assertion xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" ID="_fbb64868745bf00d0967899f87b2ab55" IssueInstant="2010-10-01T20:13:51.703Z" Version="2.0"><saml2:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity">http://saml.flexmls.com/idp/shibboleth</saml2:Issuer><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">cal</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData Address="216.147.179.14" InResponseTo="Nh4C91R3rLrc1c7pQWP9Q0r61" NotOnOrAfter="2010-10-01T20:18:51.703Z" Recipient="http://samltest-zxid.flexmls.com/ticketLogin?o=P"></saml2:SubjectConfirmationData></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2010-10-01T20:13:51.703Z" NotOnOrAfter="2010-10-01T20:18:51.703Z"><saml2:AudienceRestriction><saml2:Audience>http://samltest-zxid.flexmls.com/ticketLogin?o=B</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2010-10-01T20:13:51.683Z" SessionIndex="0f66886ce6d0ee7f605e76887a0f027dd1e38584e549818687ed5b8352af1dc4"><saml2:SubjectLocality Address="216.147.179.14"></saml2:SubjectLocality><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion>

and get
SHA1: yOU8+5UxDCahH9ju+nQK4lmyDVA=

but when Shib had canonicalized it, it had gotten
SHA1: tJQBOaU5JDRdtFgTRMrUe3K7Sqk=

Hence a signature failure due to canonicalization is flagged.

Question: How can my user obtain the canonicalized form in the IdP end?
What debugging flags and logs he needs to turn on to see the input
to your SHA1 computation?

I then explored if I could guess how Shib miscanonicalizes. I edited
the canonicalization to remove the xmlns:ds declaration:

<saml2:Assertion xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" ID="_fbb64868745bf00d0967899f87b2ab55" IssueInstant="2010-10-01T20:13:51.703Z" Version="2.0"><saml2:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity">http://saml.flexmls.com/idp/shibboleth</saml2:Issuer><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">cal</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData Address="216.147.179.14" InResponseTo="Nh4C91R3rLrc1c7pQWP9Q0r61" NotOnOrAfter="2010-10-01T20:18:51.703Z" Recipient="http://samltest-zxid.flexmls.com/ticketLogin?o=P"></saml2:SubjectConfirmationData></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2010-10-01T20:13:51.703Z" NotOnOrAfter="2010-10-01T20:18:51.703Z"><saml2:AudienceRestriction><saml2:Audience>http://samltest-zxid.flexmls.com/ticketLogin?o=B</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2010-10-01T20:13:51.683Z" SessionIndex="0f66886ce6d0ee7f605e76887a0f027dd1e38584e549818687ed5b8352af1dc4"><saml2:SubjectLocality Address="216.147.179.14"></saml2:SubjectLocality><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion>

Now the SHA1 I get matches the SHA1 in the signature.

But this canonicalization is wrong because it ignores
InclusiveNamespaces/@PrefixList, thus violating section 3, bullet 2,
of [XML-EXC-C14N]. This part of the spec is very bad and difficult to
understand, merely stating "All namespace nodes appearing on this list
are handled as provided in Canonical XML [XML-C14N]." for whatever
that might mean. However studying non-normative section 3.1 bullet 3.2.1
of [XML-EXC-C14N] makes it clear that the xmlns:ds needs to be rendered.

[XML-EXC-C14N] John Boyer, Donald E. Eastlake 3rd, Joseph Reagle: "Exclusive
  XML Canonicalization Version 1.0", W3C Recommendation 18 July 2002,
  http://www.w3.org/TR/xml-exc-c14n/

[XML-C14N] XML Canonicalization (non-exclusive),
  http://www.w3.org/TR/2001/REC-xml-c14n-20010315; J. Boyer: "Canonical
  XML Version 1.0", W3C Recommendation, 15.3.2001,
  http://www.w3.org/TR/xml-c14n, RFC3076

Proposed fixes:

1. Just drop the InclusiveNamespaces/@PrefixList. In the assertion
   at hand, it serves no purpose. This is probably a backwards
   compatible fix.

2. Fix your XML canonicalizator to deal correctly with InclusiveNamespaces.
   Problem with this fix, if not combined with (1) is that it may
   break your installed base.

Cheers,
--Sampo

From	Cal Heldenbrand <cal@fbsdata.com>
To	sampo@zxidp.org
Cc	
Date	Sun, 3 Oct 2010 19:48:24 -0500 -- arrived: Ma 4.10. 0h41 -- S 5.09K
Subject	Re: ZXID support?
>
> zxid.pl represents the "low level" API. My preferred / recommended example
> is zxidhlo.pl
> which uses the zxid_simple() API, so you may want to consider using that.
>
> Okay, when I get back in the office on Monday I'll take a look at that
script and do a few tests.


>
> I think the easiest way to accomplish this is: you buy 1 day of consulting
> at $1600/day. I think
> one day will be the amount. My rate may seem high, but I am highly
> specialized.
>
> To get the ball rolling, all I need is a Purchase Order. If you want to
> sign any additional
> service supply agreements, we can do that, too. But for me PO is
> sufficient. If that
> is fine with you as well, please create PO with following itemization, sign
> it, and send it
> by fax to +351-211.923.068 or scan the signed copy and mail to me.
>
> Purchase Order, date
> Client: FBS Data (you should use FBS Data's letter head or PO form)
> Supplier: Levelview, Lda. Rua Almocreves 16, 7580-150 Alcacer do Sal,
> Portugal
> Services: One day of ZXID support for Shibboleth integration
> Price: $1600
>
>

Thanks Sampo, I'm going to run this price by my manager on Monday and let
you know if we can budget it.

--Cal


From	sampo@zxidp.org
To	cal@fbsdata.com
Cc	sampo@zxidp.org
Date	Mon, 4 Oct 2010 01:51:21 +0200 (CEST) -- arrived: Su 3.10. 23h51 -- S 8.96K
Subject	Re: ZXID support?
Cal Heldenbrand <cal@fbsdata.com> said:
> Hi Sampo,
>
> I've been tracing through this a little more and haven't found anything that
> sticks out. I changed around the method I used for handling the post
> request body in my mod_perl code, and it seems to have made a slight
> difference in the error message. I'm not sure if this had anything to do
> with it, but I was calling new_cgi() with all of the get/post parameters
> combined, then calling parse_cgi() again with the same list. I don't know
> if that messes up some internal state, so on operation P, I'm not calling
> parse_cgi() now.
>
> (My mod_perl code is based heavily off your zxid.pl example script)

zxid.pl represents the "low level" API. My preferred / recommended example is zxidhlo.pl
which uses the zxid_simple() API, so you may want to consider using that.

> I have the logs from both SP and IdP attached. There's a lot of debug info,
> so hopefully you can pick out the important stuff. I've also attached
> /var/zxid/log/rely/U1P0XrwXMFHdAqVbFUpnrDvDV3g/wir/qI43MqiZehHt9pn8imn4Q6qzyEU
> to compare with the log file.

Thanks. Looked at these. The Response sent from shib IdP is superficially
ok, so my main suspect is now the whitespace in the message. Myself,
I avoid sending any superfluous whitespace over the network. They apparently
send whitespace, and there may be some canonicalization corner case
there. I'll have to build a little test jig program to run my test over the
saml2p:Response I recovered from the files you sent.

> In seeing the latest email on the list, I had to double check for CRLF's
> coming from the IdP since that seemed so similar to my case. I ran a packet
> sniff, decoded the SAMLReponse for that last POST request, and the MD5 sum
> matches up with the qI43MqiZehHt9pn8imn4Q6qzyEU file, so that's not the
> issue.
>
> The only thing odd I can see, is the zxlog line with:
>
> t zxlog.c:425 zxlog zx d ssof: LOG(201)
>
> When I compare that to the text log in /var/zxid/log/err, I see the full
> message with a messed up character in there:
>
> PP - 201^@1001-201142.195 19700101-000000.501 -:- - - - - zx N W
> ANREDIR http://saml.flexmls.com/idp/shibboleth -
> PP - 201^@1001-201347.584 19700101-000000.501 -:- - - - - zx N W
> REDIRDEC - sid() len=8872
> PP - 201^@1001-201347.585 19700101-000000.501 -:- - - - - zx N K
> SAMLOK SAMLresp -
> PP - 201^@1001-201347.585 20101002-021351.501 -:-
> U1P0XrwXMFHdAqVbFUpnrDvDV3g - _fbb64868745bf00d0967899f87b2ab55 cal zx G P
> FEDSSO 0f66886ce6d0ee7f605e76887a0f027dd1e38584e549818687ed5b8352af1dc4
> Error.
>
> Taking a quick hex dump just to make sure:
> 00012060 72 65 73 70 20 2d 0a 50 50 20 2d 20 32 30 31 00 |resp -.PP -
> 201.|
> 00012070 31 30 30 31 2d 32 30 31 33 34 37 2e 35 38 35 20 |1001-201347.585
> |
>
> After the 201, there is a null character instead of a zero, but I have no
> idea if this has any relation to my checksums being wrong. Just thought I'd
> point it out.

The nul in wrong place is unrelated problem.

> Again, thanks for taking the time to look at my issue. I am willing to pay
> for support, just let me know what your usual procedure is for something
> like this. I think if something like this requires a code modification on
> your end, it's a valuable service, and is worth the cost to bump me up on
> your priority queue. :-)

I think the easiest way to accomplish this is: you buy 1 day of consulting at $1600/day. I think
one day will be the amount. My rate may seem high, but I am highly specialized.

To get the ball rolling, all I need is a Purchase Order. If you want to sign any additional
service supply agreements, we can do that, too. But for me PO is sufficient. If that
is fine with you as well, please create PO with following itemization, sign it, and send it
by fax to +351-211.923.068 or scan the signed copy and mail to me.

Purchase Order, date
Client: FBS Data (you should use FBS Data's letter head or PO form)
Supplier: Levelview, Lda. Rua Almocreves 16, 7580-150 Alcacer do Sal, Portugal
Services: One day of ZXID support for Shibboleth integration
Price: $1600

Cheers,
--Sampo

> Please let me know if you want any more info, I could also provide some code
> snippets of what I'm doing, but it's very similar to the example you've
> provided.
>
> Thanks,
>
> --Cal
>
> ------------------------------------------
> Cal Heldenbrand
> FBS - creators of flexmls®
> 3415 39th St S
> Fargo, ND 58104-7534
> Phone: (701) 499-0349
> E-mail: cal@fbsdata.com
>
>
> 2010/9/30 Cal Heldenbrand <cal@fbsdata.com>
>
> > Thanks for the quick reply! I did try to subscribe to the list with these
> > instructions <http://listproc.unh.edu/archives/zxid.user/>, but got a kick
> > back about needing to be manually added to the list. (no auto
> > subscriptions) Anyway, I'll just paste in my other email:
> >
> > I'm having a problem with Shibboleth IdP 2.1.5, using zxid 0.64 in a
> > mod_perl environment. After logging in at the IdP and redirecting back to
> > the SP, I get:
> >
> > t zxidsso.c:343 zxid_sigres_map zx E Bad digest. Canon problem? 3
> > t zxidlib.c:736 zxid_chk_sig zx d Response sigres(3)
> > t zxidsso.c:582 zxid_sp_sso_finalize zx d ssof: SSOA7N received.
> > NID(cal) FMT(1)
> > SESIX(1619b8e73d3a5b6526feeb77d0bec0e52dded0770748ca21900d2e3add307492)
> > t zxidsso.c:343 zxid_sigres_map zx E ssof: Bad digest. Canon
> > problem? 3
> > t zxidsso.c:618 zxid_sp_sso_finalize zx E ssof: Fail SSO due to failed
> > signature sigres=3
> > t zxidsso.c:658 zxid_sp_sso_finalize zx E ssof: SSO fail (P)
> > t zxlog.c:423 zxlog zx d ssof: LOG(20100929-211214.057
> > 20100930-031215.501 -:- U1P0XrwXMFHdAqVbFUpnrDvDV3g -
> > _257c50d17390ea37c5a858cd3d8edb0a cal zx G P FEDSSO
> > 1619b8e73d3a5b6526feeb77d0bec0e52dded0770748ca21900d2e3add307492 Error.)
> > t zxidspx.c:109 zxid_sp_dispatch zx d ret=0
> > t zxidspx.c:113 zxid_sp_dispatch zx d *** FAIL, should send back to
> > IdP select 0
> >
> > I've been reading through the docs, trying various config changes to
> > disable signature checks, but I still get a failure:
> >
> > t zxidsso.c:606 zxid_sp_sso_finalize zx E ssof: SSO warn: assertion not
> > signed. Sigval(G) (nil)
> > t zxidsso.c:618 zxid_sp_sso_finalize zx E ssof: Fail SSO due to failed
> > signature sigres=7
> > t zxidsso.c:658 zxid_sp_sso_finalize zx E ssof: SSO fail (P)
> > t zxlog.c:423 zxlog zx d ssof: LOG(20100929-193238.904
> > 20100930-013239.501 -:- U1P0XrwXM
> > FHdAqVbFUpnrDvDV3g - _6a2826ed7f476e92f7ab16d488703a14 cal zx N P FEDSSO
> > 942d8e136807fba43542ed752246994452
> > 5e5b06262134feddcbd27dbe19cfbf Error.)
> > t zxidspx.c:109 zxid_sp_dispatch zx d ret=0
> > t zxidspx.c:113 zxid_sp_dispatch zx d *** FAIL, should send back to
> > IdP select 0
> >
> > I've also tried changing my RSA keys to be signed for my domain, and a lot
> > of other trial & error stuff. Any idea why the signature check fails?
> >
> >
> >
> > Please contact me by phone +351-918.731.007 or by skype chat:
> >> sampo.kellomaki
> >> Or send me your phone and I can call you. I think given your deadline,
> >> we should talk tomorrow (Fri). My timezone is GMT (London, Lisbon) and
> >> I work late so office hours of US east coast are OK. What is your
> >> timezone?
> >>
> >>
> > If you'd like to do a phone call, that would work, or email is just fine
> > for me too. I'm in Central time zone, so that's 5 hours behind you. I
> > usually get in the office around 9, so some time after 2:00pm your time
> > would be great. My office phone is 701-499-0349.
> >
> > I think you can safely say that there are no deal breakers.
> >>
> >> I still need to see your original problem report to understand what
> >> rough edge you are hitting, but I am very confident that it can be
> >> solved by the deadline.
> >>
> >> Sounds great! I've been working at this for about a week, integrating
> > SAML along side our current authentication system. I feel I'm really close,
> > and it's just something dumb I'm missing that I will never find on my own.
> >
> > Let me know if you need more info from me! I'll attach my SP and IdP
> > metadata, as I'm sure you will probably want to take a peek at that.
> >
> > --Cal
> >
> > ------------------------------------------
> > Cal Heldenbrand
